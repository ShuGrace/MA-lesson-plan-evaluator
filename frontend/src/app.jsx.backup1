import React, { useState, useEffect, useRef } from 'react';
import { Send, BookOpen, TrendingUp, Users, Globe, FileText, AlertCircle, CheckCircle, Loader, Database, History, Target, Brain, ClipboardCheck, MessageCircle, Upload, FileCheck, X, Download, Sparkles } from 'lucide-react';
import './App.css';

const API_BASE_URL = 'http://localhost:8000';

function App() {
  // ÂéüÊúâÁä∂ÊÄÅ
  const [lessonTitle, setLessonTitle] = useState('');
  const [lessonContent, setLessonContent] = useState('');
  const [gradeLevel, setGradeLevel] = useState('');
  const [subjectArea, setSubjectArea] = useState('');
  
  const [isEvaluating, setIsEvaluating] = useState(false);
  const [evaluationResult, setEvaluationResult] = useState(null);
  const [error, setError] = useState(null);
  const [saveStatus, setSaveStatus] = useState(null);
  
  const [savedEvaluations, setSavedEvaluations] = useState([]);
  const [showHistory, setShowHistory] = useState(false);
  const [statistics, setStatistics] = useState(null);

  // Êñ∞Â¢ûÁä∂ÊÄÅ - Êñá‰ª∂‰∏ä‰º†ÂäüËÉΩ
  const [inputMode, setInputMode] = useState('text'); // 'text' or 'file'
  const [uploadedFile, setUploadedFile] = useState(null);
  const [extractedText, setExtractedText] = useState('');
  const [isDragging, setIsDragging] = useState(false);
  const [isExtracting, setIsExtracting] = useState(false);
  const fileInputRef = useRef(null);

  // Êñ∞Â¢ûÁä∂ÊÄÅ - AIÊîπËøõÊïôÊ°àÂäüËÉΩ
  const [isGenerating, setIsGenerating] = useState(false);
  const [improvedLesson, setImprovedLesson] = useState(null);

  useEffect(() => {
    loadSavedEvaluations();
    loadStatistics();
  }, []);

  const loadSavedEvaluations = async () => {
    try {
      const response = await fetch(`${API_BASE_URL}/api/evaluations?limit=20`);
      if (response.ok) {
        const data = await response.json();
        setSavedEvaluations(data.evaluations || data);
      }
    } catch (err) {
      console.error('Failed to load saved evaluations:', err);
    }
  };

  const loadStatistics = async () => {
    try {
      const response = await fetch(`${API_BASE_URL}/api/statistics`);
      if (response.ok) {
        const data = await response.json();
        setStatistics(data.statistics || data);
      }
    } catch (err) {
      console.error('Failed to load statistics:', err);
    }
  };

  // Êñá‰ª∂‰∏ä‰º†Áõ∏ÂÖ≥ÂáΩÊï∞
  const handleFileSelect = async (e) => {
    const file = e.target.files[0];
    if (file) {
      await processFile(file);
    }
  };

  const handleFileDrop = async (e) => {
    e.preventDefault();
    setIsDragging(false);
    
    const file = e.dataTransfer.files[0];
    if (file) {
      await processFile(file);
    }
  };

  const handleDragOver = (e) => {
    e.preventDefault();
    setIsDragging(true);
  };

  const handleDragLeave = () => {
    setIsDragging(false);
  };

  const processFile = async (file) => {
    const validTypes = [
      'application/pdf', 
      'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
      'application/msword'
    ];
    
    if (!validTypes.includes(file.type)) {
      setError('Only PDF and Word (.docx, .doc) files are supported');
      return;
    }
    
    setUploadedFile(file);
    setError(null);
    setIsExtracting(true);
    
    const formData = new FormData();
    formData.append('file', file);
    
    try {
      const response = await fetch(`${API_BASE_URL}/api/extract-text`, {
        method: 'POST',
        body: formData,
      });
      
      if (!response.ok) {
        throw new Error('File processing failed');
      }
      
      const data = await response.json();
      setExtractedText(data.text);
      setLessonContent(data.text);
      
      if (data.metadata?.title) {
        setLessonTitle(data.metadata.title);
      }
      
    } catch (err) {
      setError(`File processing failed: ${err.message}`);
    } finally {
      setIsExtracting(false);
    }
  };

  const clearUploadedFile = () => {
    setUploadedFile(null);
    setExtractedText('');
    if (inputMode === 'file') {
      setLessonContent('');
    }
  };

  // AIÊîπËøõÊïôÊ°àÂáΩÊï∞
  const handleGenerateImprovedLesson = async () => {
    setIsGenerating(true);
    setError(null);
    
    try {
      const allRecommendations = [];
      
      evaluationResult.agent_responses.forEach(agent => {
        if (agent.recommendations) {
          allRecommendations.push(...agent.recommendations);
        }
        
        if (agent.analysis) {
          Object.values(agent.analysis).forEach(dimension => {
            if (dimension.gaps) {
              allRecommendations.push(...dimension.gaps);
            }
            if (dimension.areas_for_improvement) {
              allRecommendations.push(...dimension.areas_for_improvement);
            }
          });
        }
      });
      
      const response = await fetch(`${API_BASE_URL}/api/improve-lesson`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          original_lesson: lessonContent,
          lesson_title: lessonTitle,
          grade_level: gradeLevel,
          subject_area: subjectArea,
          recommendations: allRecommendations,
          scores: evaluationResult.scores
        }),
      });
      
      if (!response.ok) {
        throw new Error('Failed to generate improved lesson');
      }
      
      const data = await response.json();
      setImprovedLesson(data.improved_lesson);
      
    } catch (err) {
      setError(`Failed to generate improved lesson plan: ${err.message}`);
    } finally {
      setIsGenerating(false);
    }
  };

  const handleEvaluate = async () => {
    const contentToEvaluate = inputMode === 'file' ? extractedText : lessonContent;
    
    if (!lessonTitle.trim() || !contentToEvaluate.trim()) {
      setError('Please enter both lesson title and content');
      return;
    }

    setIsEvaluating(true);
    setError(null);
    setEvaluationResult(null);
    setSaveStatus(null);
    setImprovedLesson(null);

    try {
      const evalResponse = await fetch(`${API_BASE_URL}/api/evaluate/lesson`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          text: contentToEvaluate,
          title: lessonTitle,
          grade_level: gradeLevel,
          subject_area: subjectArea,
        }),
      });

      if (!evalResponse.ok) {
        throw new Error(`Evaluation failed: ${evalResponse.status}`);
      }

      const evalData = await evalResponse.json();
      
      const completeResult = {
        evaluation_id: evalData.evaluation_id,
        scores: {
          place_based_learning: evalData.scores?.place_based_learning || 0,
          cultural_responsiveness: evalData.scores?.cultural_responsiveness || 0,
          critical_pedagogy: evalData.scores?.critical_pedagogy || 0,
          assessment_quality: evalData.scores?.assessment_quality || 0,
          reflective_practice: evalData.scores?.reflective_practice || 0,
          overall: evalData.scores?.overall || 0,
        },
        agent_responses: evalData.agent_responses || [],
        debate_transcript: evalData.debate_transcript || {},
        recommendations: evalData.recommendations || [],
      };
      
      setEvaluationResult(completeResult);
      
      await loadSavedEvaluations();
      await loadStatistics();

      setSaveStatus('success');
      setTimeout(() => setSaveStatus(null), 3000);

    } catch (err) {
      setError(`Failed to evaluate: ${err.message}. Please ensure backend server is running on port 8000.`);
      console.error('Evaluation error:', err);
    } finally {
      setIsEvaluating(false);
    }
  };

  const handleLoadEvaluation = async (evalId) => {
    try {
      const response = await fetch(`${API_BASE_URL}/api/evaluations/${evalId}`);
      if (!response.ok) {
        throw new Error('Failed to load evaluation');
      }

      const data = await response.json();
      const evaluation = data.evaluation || data;
      
      const agentResponses = typeof evaluation.agent_responses === 'string' 
        ? JSON.parse(evaluation.agent_responses) 
        : evaluation.agent_responses || [];
      
      const debateTranscript = typeof evaluation.debate_transcript === 'string'
        ? JSON.parse(evaluation.debate_transcript)
        : evaluation.debate_transcript || {};
      
      const recommendations = typeof evaluation.recommendations === 'string'
        ? JSON.parse(evaluation.recommendations)
        : evaluation.recommendations || [];

      setEvaluationResult({
        evaluation_id: evaluation.id,
        scores: {
          place_based_learning: evaluation.place_based_score,
          cultural_responsiveness: evaluation.cultural_score,
          critical_pedagogy: 76,
          assessment_quality: 74,
          reflective_practice: 73,
          overall: evaluation.overall_score,
        },
        agent_responses: agentResponses,
        debate_transcript: debateTranscript,
        recommendations: recommendations,
      });

      setLessonTitle(evaluation.lesson_plan_title || '');
      setLessonContent(evaluation.lesson_plan_text || '');
      setGradeLevel(evaluation.grade_level || '');
      setSubjectArea(evaluation.subject_area || '');

      setShowHistory(false);
      setImprovedLesson(null);
    } catch (err) {
      setError(`Failed to load evaluation: ${err.message}`);
    }
  };

  const handleDeleteEvaluation = async (evalId) => {
    if (!window.confirm('Are you sure you want to delete this evaluation?')) {
      return;
    }

    try {
      const response = await fetch(`${API_BASE_URL}/api/evaluations/${evalId}`, {
        method: 'DELETE',
      });

      if (!response.ok) {
        throw new Error('Failed to delete evaluation');
      }

      await loadSavedEvaluations();
      await loadStatistics();
      
      if (evaluationResult?.evaluation_id === evalId) {
        setEvaluationResult(null);
      }
    } catch (err) {
      setError(`Failed to delete evaluation: ${err.message}`);
    }
  };

  const getScoreColor = (score) => {
    if (score >= 80) return '#10b981';
    if (score >= 60) return '#f59e0b';
    return '#ef4444';
  };

  const getScoreLabel = (score) => {
    if (score >= 80) return 'Excellent';
    if (score >= 60) return 'Good';
    if (score >= 40) return 'Fair';
    return 'Needs Improvement';
  };

  const ScoreCircle = ({ score, label, icon, color }) => {
    const IconComponent = icon;
    return (
      <div className="score-circle-card">
        <div className="score-circle-header">
          <IconComponent size={24} color={color} />
          <h4>{label}</h4>
        </div>
        <div className="score-circle-container">
          <svg width="120" height="120" viewBox="0 0 120 120">
            <circle
              cx="60"
              cy="60"
              r="54"
              fill="none"
              stroke="#e5e7eb"
              strokeWidth="12"
            />
            <circle
              cx="60"
              cy="60"
              r="54"
              fill="none"
              stroke={color}
              strokeWidth="12"
              strokeDasharray={`${(score / 100) * 339.292} 339.292`}
              strokeLinecap="round"
              transform="rotate(-90 60 60)"
              style={{ transition: 'stroke-dasharray 1s ease-out' }}
            />
            <text
              x="60"
              y="60"
              textAnchor="middle"
              dy=".3em"
              fontSize="24"
              fontWeight="700"
              fill={color}
            >
              {score}
            </text>
          </svg>
          <span className="score-circle-label" style={{ color }}>
            {getScoreLabel(score)}
          </span>
        </div>
      </div>
    );
  };

  return (
    <div className="app-container">
      <header className="app-header">
        <div className="header-content">
          <BookOpen className="header-icon" />
          <h1>üéì Lesson Plan Evaluator</h1>
          <p className="header-subtitle">
            AI-Powered Multi-Agent Evaluation System for New Zealand Educators
          </p>
          {statistics && (
            <div className="stats-bar">
              <div className="stat-item">
                <Database size={16} />
                <span>Total Evaluations: {statistics.total_evaluations || 0}</span>
              </div>
              <div className="stat-item">
                <TrendingUp size={16} />
                <span>Avg Score: {statistics.average_score?.toFixed(1) || 'N/A'}</span>
              </div>
            </div>
          )}
        </div>
      </header>

      <main className="main-content-centered">
        <div className="content-wrapper">
          <div className="history-toggle">
            <button className="toggle-button" onClick={() => setShowHistory(!showHistory)}>
              <History size={20} />
              {showHistory ? 'Hide History' : 'Show History'}
              {savedEvaluations.length > 0 && (
                <span className="badge">{savedEvaluations.length}</span>
              )}
            </button>
          </div>

          {showHistory && (
            <div className="history-sidebar">
              <h3>
                <History size={20} />
                Evaluation History
              </h3>
              {savedEvaluations.length === 0 ? (
                <p className="no-history">No saved evaluations yet</p>
              ) : (
                <div className="history-list">
                  {savedEvaluations.map((evaluation) => (
                    <div key={evaluation.id} className="history-item">
                      <div className="history-item-header">
                        <strong>{evaluation.lesson_plan_title || 'Untitled'}</strong>
                        <span className={`status-badge status-${evaluation.status}`}>
                          {evaluation.status}
                        </span>
                      </div>
                      <div className="history-item-meta">
                        <span>üìä Overall: {evaluation.overall_score}/100</span>
                        <span>üåç Place-Based: {evaluation.place_based_score}/100</span>
                        <span>üé≠ Cultural: {evaluation.cultural_score}/100</span>
                      </div>
                      <div className="history-item-date">
                        {new Date(evaluation.created_at).toLocaleString()}
                      </div>
                      <div className="history-item-actions">
                        <button 
                          className="btn-small btn-primary"
                          onClick={() => handleLoadEvaluation(evaluation.id)}
                        >
                          Load
                        </button>
                        <button 
                          className="btn-small btn-danger"
                          onClick={() => handleDeleteEvaluation(evaluation.id)}
                        >
                          Delete
                        </button>
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>
          )}

          <div className="input-section">
            <h2>üìù Evaluate Lesson Plan</h2>
            
            {/* ËæìÂÖ•Ê®°ÂºèÈÄâÈ°πÂç° */}
            <div className="input-tabs">
              <button 
                className={`tab-button ${inputMode === 'text' ? 'active' : ''}`}
                onClick={() => setInputMode('text')}
              >
                üìù Text Input
              </button>
              <button 
                className={`tab-button ${inputMode === 'file' ? 'active' : ''}`}
                onClick={() => setInputMode('file')}
              >
                üìÑ Upload File
              </button>
            </div>

            {/* ÊñáÊú¨ËæìÂÖ•Ê®°Âºè */}
            {inputMode === 'text' && (
              <div className="text-input-mode">
                <div className="form-row">
                  <div className="form-group">
                    <label>
                      <FileText size={18} />
                      Lesson Plan Title
                    </label>
                    <input
                      type="text"
                      value={lessonTitle}
                      onChange={(e) => setLessonTitle(e.target.value)}
                      placeholder="Enter lesson plan title..."
                    />
                  </div>
                  <div className="form-group">
                    <label>
                      <Users size={18} />
                      Grade Level
                    </label>
                    <input
                      type="text"
                      value={gradeLevel}
                      onChange={(e) => setGradeLevel(e.target.value)}
                      placeholder="e.g., Year 5-6"
                    />
                  </div>
                </div>

                <div className="form-group">
                  <label>
                    <BookOpen size={18} />
                    Subject Area
                  </label>
                  <input
                    type="text"
                    value={subjectArea}
                    onChange={(e) => setSubjectArea(e.target.value)}
                    placeholder="e.g., Science, Social Studies"
                  />
                </div>

                <div className="form-group">
                  <label>
                    <FileText size={18} />
                    Lesson Plan Content
                  </label>
                  <textarea
                    value={lessonContent}
                    onChange={(e) => setLessonContent(e.target.value)}
                    placeholder="Paste your lesson plan content here..."
                  />
                </div>
              </div>
            )}

            {/* Êñá‰ª∂‰∏ä‰º†Ê®°Âºè */}
            {inputMode === 'file' && (
              <div className="file-upload-mode">
                {!uploadedFile ? (
                  <div 
                    className={`file-drop-zone ${isDragging ? 'dragging' : ''}`}
                    onDrop={handleFileDrop}
                    onDragOver={handleDragOver}
                    onDragLeave={handleDragLeave}
                    onClick={() => fileInputRef.current?.click()}
                  >
                    <Upload size={48} />
                    <h3>Drag & drop file here, or click to upload</h3>
                    <p>Supported formats: Word (.docx) and PDF (.pdf)</p>
                    <input
                      type="file"
                      ref={fileInputRef}
                      accept=".docx,.pdf,.doc"
                      onChange={handleFileSelect}
                      style={{ display: 'none' }}
                    />
                    <button className="file-select-button" onClick={(e) => e.stopPropagation()}>
                      Select File
                    </button>
                  </div>
                ) : (
                  <div>
                    <div className="uploaded-file-info">
                      <FileCheck size={24} color="#10b981" />
                      <div style={{ flex: 1 }}>
                        <strong>{uploadedFile.name}</strong>
                        <br />
                        <span style={{ fontSize: '0.875rem', color: '#64748b' }}>
                          {(uploadedFile.size / 1024).toFixed(2)} KB
                        </span>
                      </div>
                      <button 
                        onClick={clearUploadedFile}
                        style={{ background: 'none', border: 'none', cursor: 'pointer' }}
                      >
                        <X size={20} color="#ef4444" />
                      </button>
                    </div>

                    {isExtracting && (
                      <div style={{ textAlign: 'center', padding: '2rem' }}>
                        <Loader className="spinning" size={32} />
                        <p>Extracting text...</p>
                      </div>
                    )}

                    {extractedText && !isExtracting && (
                      <div className="extracted-text-preview">
                        <h4>üìÑ Extracted Text Content:</h4>
                        <div className="preview-content">
                          {extractedText.substring(0, 500)}
                          {extractedText.length > 500 && '...'}
                        </div>
                        <p style={{ marginTop: '1rem', color: '#64748b', fontSize: '0.875rem' }}>
                          Total {extractedText.length} characters extracted
                        </p>
                      </div>
                    )}

                    {/* ÂÖÉÊï∞ÊçÆËæìÂÖ• */}
                    {extractedText && (
                      <div style={{ marginTop: '1.5rem' }}>
                        <div className="form-row">
                          <div className="form-group">
                            <label>
                              <FileText size={18} />
                              Lesson Plan Title
                            </label>
                            <input
                              type="text"
                              value={lessonTitle}
                              onChange={(e) => setLessonTitle(e.target.value)}
                              placeholder="Enter lesson plan title..."
                            />
                          </div>
                          <div className="form-group">
                            <label>
                              <Users size={18} />
                              Grade Level
                            </label>
                            <input
                              type="text"
                              value={gradeLevel}
                              onChange={(e) => setGradeLevel(e.target.value)}
                              placeholder="e.g., Year 5-6"
                            />
                          </div>
                        </div>

                        <div className="form-group">
                          <label>
                            <BookOpen size={18} />
                            Subject Area
                          </label>
                          <input
                            type="text"
                            value={subjectArea}
                            onChange={(e) => setSubjectArea(e.target.value)}
                            placeholder="e.g., Science, Social Studies"
                          />
                        </div>
                      </div>
                    )}
                  </div>
                )}
              </div>
            )}

            <button 
              className="evaluate-button"
              onClick={handleEvaluate}
              disabled={isEvaluating || !lessonTitle.trim() || (inputMode === 'text' ? !lessonContent.trim() : !extractedText)}
            >
              {isEvaluating ? (
                <>
                  <Loader className="button-icon spinning" />
                  Evaluating...
                </>
              ) : (
                <>
                  <Send className="button-icon" />
                  Evaluate Lesson Plan
                </>
              )}
            </button>

            {error && (
              <div className="error-message">
                <AlertCircle size={20} />
                {error}
              </div>
            )}

            {saveStatus === 'success' && (
              <div className="success-message">
                <CheckCircle size={20} />
                Evaluation saved successfully!
              </div>
            )}
          </div>

          {evaluationResult && (
            <div className="results-section">
              <div className="results-header">
                <h2>üìä Evaluation Results</h2>
                <div className="results-meta">
                  <CheckCircle size={16} />
                  Evaluation Complete
                </div>
              </div>

              {/* Overall Score */}
              {evaluationResult.scores.overall !== undefined && (
                <div className="overall-score-section">
                  <h3>Overall Score</h3>
                  <ScoreCircle
                    score={evaluationResult.scores.overall}
                    label="Overall"
                    icon={Target}
                    color="#667eea"
                  />
                </div>
              )}

              {/* Dimension Scores Grid */}
              <div className="dimension-scores-grid">
                {evaluationResult.scores.place_based_learning !== undefined && (
                  <ScoreCircle
                    score={evaluationResult.scores.place_based_learning}
                    label="Place-Based Learning"
                    icon={Globe}
                    color="#10b981"
                  />
                )}
                {evaluationResult.scores.cultural_responsiveness !== undefined && (
                  <ScoreCircle
                    score={evaluationResult.scores.cultural_responsiveness}
                    label="Cultural Responsiveness"
                    icon={Users}
                    color="#3b82f6"
                  />
                )}
                {evaluationResult.scores.critical_pedagogy !== undefined && (
                  <ScoreCircle
                    score={evaluationResult.scores.critical_pedagogy}
                    label="Critical Pedagogy"
                    icon={Brain}
                    color="#8b5cf6"
                  />
                )}
                {evaluationResult.scores.assessment_quality !== undefined && (
                  <ScoreCircle
                    score={evaluationResult.scores.assessment_quality}
                    label="Assessment Quality"
                    icon={ClipboardCheck}
                    color="#f59e0b"
                  />
                )}
                {evaluationResult.scores.reflective_practice !== undefined && (
                  <ScoreCircle
                    score={evaluationResult.scores.reflective_practice}
                    label="Reflective Practice"
                    icon={MessageCircle}
                    color="#ec4899"
                  />
                )}
              </div>

              {/* AIÊîπËøõÊïôÊ°àÊåâÈíÆ */}
              <div className="improvement-action-section">
                <h3>‚ú® Want an Improved Lesson Plan?</h3>
                <p style={{ marginBottom: '1.5rem', color: '#64748b' }}>
                  Based on all evaluation suggestions above, let AI generate an optimized complete lesson plan for you
                </p>
                <button 
                  className="generate-improvement-button"
                  onClick={handleGenerateImprovedLesson}
                  disabled={isGenerating}
                >
                  {isGenerating ? (
                    <>
                      <Loader className="spinning" size={20} />
                      Generating Improved Lesson Plan...
                    </>
                  ) : (
                    <>
                      <Sparkles size={20} />
                      Generate Improved Lesson Plan
                    </>
                  )}
                </button>
              </div>

              {/* ÊòæÁ§∫ÊîπËøõÂêéÁöÑÊïôÊ°à */}
              {improvedLesson && (
                <div className="improved-lesson-section">
                  <div className="improved-lesson-header">
                    <h3>‚ú® Improved Lesson Plan</h3>
                    <button onClick={async () => {
                      try {
                        // Convert markdown to Word-friendly format
                        const response = await fetch(`${API_BASE_URL}/api/convert-to-word`, {
                          method: 'POST',
                          headers: { 'Content-Type': 'application/json' },
                          body: JSON.stringify({
                            content: improvedLesson,
                            filename: `${lessonTitle || 'lesson'}_improved.docx`
                          })
                        });
                        
                        if (response.ok) {
                          const blob = await response.blob();
                          const url = URL.createObjectURL(blob);
                          const a = document.createElement('a');
                          a.href = url;
                          a.download = `${lessonTitle || 'lesson'}_improved.docx`;
                          a.click();
                        } else {
                          // Fallback to text file if Word conversion fails
                          const blob = new Blob([improvedLesson], { type: 'text/plain' });
                          const url = URL.createObjectURL(blob);
                          const a = document.createElement('a');
                          a.href = url;
                          a.download = `${lessonTitle || 'lesson'}_improved.txt`;
                          a.click();
                        }
                      } catch (err) {
                        console.error('Download error:', err);
                        // Fallback to text file
                        const blob = new Blob([improvedLesson], { type: 'text/plain' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `${lessonTitle || 'lesson'}_improved.txt`;
                        a.click();
                      }
                    }}>
                      <Download size={16} />
                      Download
                    </button>
                  </div>
                  <div className="improved-lesson-content">
                    <pre>{improvedLesson}</pre>
                  </div>
                </div>
              )}

              {/* Agent Responses with Details */}
              {evaluationResult.agent_responses && evaluationResult.agent_responses.length > 0 && (
                <div className="agent-evaluations-section">
                  <h3>Agent Evaluations</h3>
                  {evaluationResult.agent_responses.map((agent, index) => (
                    <div key={index} className="agent-evaluation-card">
                      <div className="agent-card-header">
                        <div>
                          <h4>{agent.agent}</h4>
                          <span className="agent-role">{agent.role}</span>
                        </div>
                      </div>

                      {agent.analysis && (
                        <div className="agent-analysis">
                          {Object.entries(agent.analysis).map(([key, value]) => (
                            <div key={key} className="analysis-dimension">
                              <h5>{key.replace(/_/g, ' ').toUpperCase()}</h5>
                              
                              {value.score && (
                                <div className="dimension-score-bar">
                                  <div 
                                    className="score-fill"
                                    style={{ 
                                      width: `${value.score}%`,
                                      backgroundColor: getScoreColor(value.score)
                                    }}
                                  >
                                    <span>{value.score}/100</span>
                                  </div>
                                </div>
                              )}

                              {value.strengths && value.strengths.length > 0 && (
                                <div className="analysis-section">
                                  <strong>‚úÖ Strengths:</strong>
                                  <ul>
                                    {value.strengths.map((item, i) => (
                                      <li key={i}>{item}</li>
                                    ))}
                                  </ul>
                                </div>
                              )}

                              {value.areas_for_improvement && value.areas_for_improvement.length > 0 && (
                                <div className="analysis-section">
                                  <strong>üîß Areas for Improvement:</strong>
                                  <ul>
                                    {value.areas_for_improvement.map((item, i) => (
                                      <li key={i}>{item}</li>
                                    ))}
                                  </ul>
                                </div>
                              )}

                              {value.gaps && value.gaps.length > 0 && (
                                <div className="analysis-section warning">
                                  <strong>üö© Improvement Suggestions:</strong>
                                  <ul>
                                    {value.gaps.map((item, i) => (
                                      <li key={i}>
                                        {item.replace(/‚ö†Ô∏è\s*/g, '').replace(/üö©\s*/g, '')}
                                      </li>
                                    ))}
                                  </ul>
                                </div>
                              )}
                            </div>
                          ))}
                        </div>
                      )}

                      {agent.recommendations && agent.recommendations.length > 0 && (
                        <div className="agent-recommendations">
                          <strong>üí° Recommendations ({agent.recommendations.length}):</strong>
                          <ul>
                            {agent.recommendations.map((rec, i) => (
                              <li key={i}>{rec}</li>
                            ))}
                          </ul>
                        </div>
                      )}

                      {agent.resources_suggested && agent.resources_suggested.length > 0 && (
                        <div className="agent-resources">
                          <strong>üìö Suggested Resources:</strong>
                          <div className="resource-tags">
                            {agent.resources_suggested.map((resource, i) => (
                              <span key={i} className="resource-tag">
                                {resource.replace(/_/g, ' ')}
                              </span>
                            ))}
                          </div>
                        </div>
                      )}
                    </div>
                  ))}
                </div>
              )}

              {/* Priority Recommendations */}
              {evaluationResult.debate_transcript?.consensus?.priority_recommendations && (
                <div className="priority-recommendations-section">
                  <h3>Priority Recommendations</h3>
                  {evaluationResult.debate_transcript.consensus.priority_recommendations.map((rec, idx) => (
                    <div 
                      key={idx} 
                      className={`recommendation-card priority-${rec.priority.toLowerCase()}`}
                    >
                      <div className="recommendation-header">
                        <span className="priority-badge">{rec.priority}</span>
                        <h4>{rec.recommendation}</h4>
                      </div>
                      <p className="recommendation-rationale">{rec.rationale}</p>
                      {rec.resource && (
                        <div className="recommendation-resource">
                          <BookOpen size={16} />
                          <span>Resource: {rec.resource.replace(/_/g, ' ')}</span>
                        </div>
                      )}
                    </div>
                  ))}
                </div>
              )}
            </div>
          )}
        </div>
      </main>

      <footer className="app-footer">
        <p>
          Powered by Multi-Agent AI (Claude, DeepSeek, GPT-4) | 
          New Zealand Education Context | SQLite Database
        </p>
      </footer>
    </div>
  );
}

export default App;